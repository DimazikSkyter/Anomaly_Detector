import unittest
import json
import pandas as pd
from typing import List

from matplotlib import pyplot as plt

from anomaly.detector.converter.MetricConverter import MetricConverter
from anomaly.detector.metrics.Metrics import Metrics, Metric
from anomaly.detector.parts.BehaviorDetector import BehaviorDetector


class BehaviorDetectorTests(unittest.TestCase):
    names = ["cpu_usage.csv", "resp_time.csv", "tps_finish.csv", "tps_master.csv"]

    def test_no_anomaly(self):
        with open("train.json", 'r') as file:
            json_str_train = file.read()
        with open("test_no_anomaly.json", 'r') as file_no_anomaly:
            json_str_test = file_no_anomaly.read()

        json_loads_train = json.loads(json_str_train)
        json_loads_test = json.loads(json_str_test)

        metrics_train: Metrics = MetricConverter.convert(json_loads_train, 1000, 20)

        beh_detector = BehaviorDetector(4, data_len=50, shift=15, lstm_size=256, mult=2, dropout_rate=0.3,
                                        logger_level="DEBUG")
        beh_detector.train(metrics_train, epochs=60)

        metrics_test: Metrics = MetricConverter.convert(json_loads_test, 50, 20)
        print(f"Metrics test len {metrics_test.series_length()}")
        result = beh_detector.detect(metrics_test)

        fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(24, 10))

        for key, value in metrics_train.series.items():
            ax1.plot(value, label=key)
        ax1.set_title('Train metric behavior no anomaly')
        ax1.set_xlabel('Index')
        ax1.set_ylabel('Value')
        ax1.legend()

        for key, value in metrics_test.series.items():
            ax2.plot(value, label=key)
        ax2.set_title('Test metric behavior no anomaly')
        ax2.set_xlabel('Index')
        ax2.set_ylabel('Value')
        ax2.legend()

        ax3.plot(result, label='Detector')
        ax3.set_title('Behavior detector no anomaly')
        ax3.set_xlabel('Index')
        ax3.set_ylabel('Value')
        ax3.set_ylim(0, 1.1)
        ax3.legend()

        plt.tight_layout()
        plt.show()

    def test_anomaly(self):
        import os

        print("Current working directory:", os.getcwd())

        with open("train.json", 'r') as file:
            json_str_train = file.read()
        with open("test_anomaly.json", 'r') as file_with_anomaly:
            json_str_test = file_with_anomaly.read()

        json_loads_train = json.loads(json_str_train)
        json_loads_test = json.loads(json_str_test)

        metrics_train: Metrics = MetricConverter.convert(json_loads_train, 1000, 20)

        beh_detector = BehaviorDetector(4, data_len=50, lstm_size=256, shift=5, mult=2, dropout_rate=0.3,
                                        logger_level="DEBUG")
        beh_detector.train(metrics_train, epochs=60)

        metrics_test: Metrics = MetricConverter.convert(json_loads_test, 50, 20)
        print(f"Metrics test len {metrics_test.series_length()}")
        result = beh_detector.detect(metrics_test)

        fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(24, 10))

        for key, value in metrics_train.series.items():
            ax1.plot(value, label=key)
        ax1.set_title('Train metric behavior with anomaly')
        ax1.set_xlabel('Index')
        ax1.set_ylabel('Value')
        ax1.legend()

        for key, value in metrics_test.series.items():
            ax2.plot(value, label=key)
        ax2.set_title('Behavior detector with anomaly')
        ax2.set_xlabel('Index')
        ax2.set_ylabel('Value')
        ax2.legend()

        ax3.plot(result, label='Detector')
        ax3.set_title('Behavior detector with anomaly')
        ax3.set_xlabel('Index')
        ax3.set_ylabel('Value')
        ax3.set_ylim(0, 1.1)
        ax3.legend()

        plt.tight_layout()
        plt.show()

    def test_with_data_1(self):
        data_len = 100
        behavior_detector = BehaviorDetector(4, data_len=100, shift=25, lstm_size=512, dropout_rate=0.4, logger_level="DEBUG")
        data: List[Metrics] = self._generate_data(data_len, 5000)

        split_index = int(0.75 * len(data))

        train = data[:split_index]
        test = data[split_index:]

        iteration = 0
        result = []

        for data_train in train:
            behavior_detector.train(data_train, epochs=20)

        for test_data in test:
            result_single = behavior_detector.detect(test_data)
            if result:
                result += result_single[int(data_len / 2):]
            else:
                result += result_single

        print(f"diff {result}")

        plt.plot(result, label="result")
        plt.legend()
        plt.show()

    def test_with_data_2(self):
        data_len = 100
        behavior_detector = BehaviorDetector(4, data_len=100, lstm_size=512, dropout_rate=0.4, model_type=2, logger_level="DEBUG")
        data: List[Metrics] = self._generate_data(data_len, 100000)

        split_index = int(0.75 * len(data))

        train = data[:split_index]
        test = data[split_index:]

        iteration = 0
        result = []

        for data_train in train:
            behavior_detector.train(data_train, epochs=10)

        for test_data in test:
            result_single = behavior_detector.detect(test_data)
            if result:
                result += result_single[int(data_len / 2):]
            else:
                result += result_single

        print(f"diff {result}")

        plt.plot(result, label="result")
        plt.legend()
        plt.show()


    def test_with_data_3(self):
        data_len = 100
        behavior_detector = BehaviorDetector(4, data_len=100, lstm_size=512, dropout_rate=0.4, model_type=1, logger_level="DEBUG")
        data: List[Metrics] = self._generate_data(data_len, 6800)

        split_index = int(0.75 * len(data))

        train = data[:split_index]
        test = data[split_index:]

        iteration = 0
        result = []

        for data_train in train:
            behavior_detector.train(data_train, epochs=10)

        for test_data in test:
            result_single = behavior_detector.detect(test_data)
            if result:
                result += result_single[int(data_len / 2):]
            else:
                result += result_single

        print(f"diff {result}")

        plt.plot(result, label="result")
        # plt.figure(figsize=(60, 30))
        plt.legend()
        plt.show()

    def test_print_result(self):
        result = [0.3567018476665347, 0.36058892647981566, 0.20667536643014295, 0.20200698978265497, 0.3060635838112066, 0.30449674037479824, 0.3092755586031797, 0.28677502393452137, 0.1524305894557917, 0.0728093500378385, 0.036936737876915204, 0.16840379795452398, 0.19046325456344815, 0.1478467349422954, 0.14025958949230177, 0.21317709383180838, 0.1241147046065515, 0.04508603060559502, 0.03486790012100338, 0.07581072766811447, 0.07819908503681927, 0.031033909838447782, 0.026459287101763818, 0.009037669097032741, 0.12143616179371497, 0.09999506498407928, 0.06671091991411449, 0.034124692225013686, 0.045652536624259166, 0.03991716241790999, 0.011550989811743517, 0.08683315165458771, 0.07389967540669229, 0.05379899337537808, 0.10500637132232671, 0.05130084545500724, 0.02095761201618529, 0.023614516443120626, 0.024276050151989415, 0.0222863229499769, 0.022949869771342724, 0.022949524369221264, 0.03149953778553016, 0.03084691380849036, 0.01424621207600052, 0.026913653959098394, 0.008129661392335952, 0.012215470668272221, 0.021619519828090628, 0.025595203488347762, 0.027570933352798255, 0.0229482047708367, 0.02028684771041922, 0.008414118907388635, 0.015594429306954094, 0.014920400506261422, 0.020953447576123274, 0.005243595255546074, 0.009494873130239556, 0.010176315997746488, 0.021619190200149352, 0.029538509241859523, 0.019619111459145522, 0.032800510175605035, 0.02161917281611392, 0.0353943637418207, 0.011536380874020757, 0.020953385310110817, 0.0189505898686666, 0.022284041618469863, 0.029538489068204554, 0.020286691945066604, 0.020286691945066604, 0.010176280639759172, 0.020286690157228615, 0.019619092885039824, 0.019619093332608695, 0.017610831357420698, 0.023611085087816175, 0.020953379284367246, 0.021619160781012003, 0.02822751384609845, 0.015594324391065562, 0.022284037834789272, 0.035394355076199036, 0.047527587200634325, 0.03604064773199622, 0.012215020630203743, 0.06058775087435864, 0.20710223162137353, 0.22753640868716962, 0.22545712288482256, 0.22753640868716962, 0.22712144511224086, 0.22629017902571036, 0.22042086899646474, 0.21957511899396487, 0.21957511899396487, 0.2148904951165318, 0.22378561726176827, 0.08855127073458569, 0.08781455822557827, 0.08113048017246316, 0.0796317866708468, 0.08038170956477697, 0.08411315794950636, 0.09148596036334877, 0.08485579397969445, 0.08633750267517193, 0.08781442164290953, 0.0781281344543121, 0.3165170540153206, 0.5000106805865846, 0.5000106798299173, 0.46762940306300127, 0.5979268320599138, 0.3192805710089178, 0.2976765063495641, 0.16889539011681476, 0.2907454664144288, 0.2995492557687295, 0.3034400522346977, 0.30898438979059184, 0.30856103774697696, 0.30940722284581834, 0.3136072747539005, 0.31981242915038655, 0.32022211944392964, 0.32226319020477234, 0.32671068486857735, 0.3218559569761327, 0.32751305622217164, 0.3287130342126561, 0.32751305622217164, 0.3279135252805966, 0.32671068465748443, 0.3326822148894484, 0.3326822148894484, 0.3350412727578862, 0.3362145580387166, 0.33110018851816025, 0.3177565476807013, 0.30085100727734626, 0.4115597704561048, 0.561700534317672, 0.17011764946503927, 0.29119090662103897, 0.31318956991353675, 0.4981662133345831, 0.26568940105145844, 0.41719047148038724, 0.41780275755252994, 0.4217515591154368, 0.2735573011219884, 0.38756150999108974, 0.3965646782030109, 0.2115417963315548, 0.27521996263618287, 0.49689794018566613, 0.7077975634069841, 0.3718675259839188, 0.23888556119094528, 0.3011708133720926, 0.6448239651939609, 0.7207198634254013, 0.7305317878688158, 0.7221899609604114, 0.715193760302717, 0.7118617863221798, 0.7139071910691833, 0.7548232264618846, 0.7131296549928006, 0.6891966599231176, 0.6478707969120281, 0.6664181224492298, 0.6447101088042024, 0.31371982573137724, 0.45429058184625604, 0.49042109506968956, 0.0809672491239436, 0.015669105159022867, 0.19697418091707486, 0.13085132074562045, 0.06507444177475707, 0.26071628002087943, 0.37417299836842743, 0.4679139782985122, 0.13646211877320624, 0.17730338616470354, 0.26924647306359717, 0.27284230624216965, 0.27116866475643053, 0.27640292452998194, 0.2838835716878737, 0.29053054734563666, 0.28848093606015757, 0.2994988712335329, 0.29794581828479694, 0.30082460091997787, 0.3023649573255047, 0.334456112329103, 0.3350006725927146, 0.3046558657783849, 0.18820041811907273, 0.27509192484207357, 0.32561983381958215, 0.3103596126958138, 0.09393368111877065, 0.31836705377880903, 0.09844613727016771, 0.2937796061108263, 0.3078143321828468, 0.22706134340430373, 0.31085308654448773, 0.2742287253486674, 0.31616241596780614, 0.3167373318621858, 0.3157785990502251, 0.3239368204820361, 0.3322687316477687, 0.3320858093033592, 0.3313531182747582, 0.33518191302980016, 0.34164453737368095, 0.34306364919997556, 0.3446528557856976, 0.3450049693862518, 0.34605904298485335, 0.34710972942495066, 0.3448289599956923, 0.34482895979580763, 0.3450049691864746, 0.34605904278571853, 0.34658480837967764, 0.3457080620782238, 0.34658480837967764, 0.3474592081584861, 0.34833127082240456, 0.34850540372574434, 0.3492010057289654, 0.3472845154722384, 0.3453567044143451, 0.3458835995135946, 0.3453567044143451, 0.3472845154722384, 0.3469348493459553, 0.3472845154722384, 0.3474592081584861, 0.34658480837967764, 0.34658480837967764, 0.014551116669735742, 0.005243344585389886, 0.005243407252940702, 0.005243462547832034, 0.005243506783740637, 0.014550961336228685, 0.02038619954236942, 0.018726033652727958, 0.012870915362689916, 0.020386167144388567, 0.0350785375254411, 0.06845474547522323, 0.0824779296562892, 0.08320430359261188, 0.0868189993702968, 0.0817503928065384, 0.08537654117744387, 0.09889858336030388, 0.1187836420656222, 0.11338630275549844, 0.10516517689668325, 0.06317962209474703, 0.017060191603773145, 0.16696007363686838, 0.2326472388305828, 0.23213843464045747, 0.23366282728363164, 0.23819990390926882, 0.23264723910477825, 0.23366282728363164, 0.23619007513641488, 0.2381999036390272, 0.23619007513641488, 0.23719631325507684, 0.23568595989999075, 0.23213843464045747, 0.23518117879107248, 0.23568595989999075, 0.24069736411648157, 0.23568595989999075, 0.2346757304894883, 0.23060796556242547, 0.2336628270101615, 0.23416961367157385, 0.23568595989999075, 0.23518117879107248, 0.23518117879107248, 0.23518117879107248, 0.23669352581703618, 0.24119489247731551, 0.08501992592983354, 0.08406000112202228, 0.0723822420699517, 0.07532947515018329, 0.08020015287945181, 0.08213407868364064, 0.07923009131527425, 0.07532940965488932, 0.08116809024897764, 0.07532939313175901, 0.07336663250449105, 0.0674280481112085, 0.07825796799987461, 0.0713955153844904, 0.07139551217214912, 0.07139550936135053, 0.0713955075544086, 0.08020006699523996, 0.07825795573535277, 0.08501972126048485, 0.07238210323092953, 0.12183180448495734, 0.0772838195683686, 0.08213400571410134, 0.07532936068271823, 0.07139550133049721, 0.06842307096274947, 0.07040680133937072, 0.08020006167672178, 0.07630762359659005, 0.07825795158124049, 0.06941599292848477, 0.07532936068271823, 0.0763076231992843, 0.07532936068271823, 0.08213400414486383, 0.08020006128275747, 0.08597759454410192, 0.07825795158124049, 0.08213400414486383, 0.07825795158124049, 0.08309792909236646, 0.08116805034572172, 0.08788734360604045, 0.08597759454410192, 0.08597759454410192, 0.08693346767083643, 0.0792300305167386, 0.07409912869793978, 0.198237012640877, 0.01405217103472356, 0.06528964154364303, 0.07453848832710963, 0.0643545162599849, 0.06901120715946651, 0.0763662790903945, 0.5461872120447169, 0.5330460931520773, 0.041337800986249396, 0.06341749371767569, 0.0680835090940598, 0.07545319980412324, 0.08180672087790564, 0.07270325694413005, 0.07362171493419978, 0.0781868613265998, 0.07453835392167729, 0.06622266967064527, 0.08984833894336075, 0.09425534031667915, 0.08180670694098857, 0.05394382615855431, 0.08000034124865973, 0.08984833643603352, 0.11650067775685291, 0.35167262443679215, 0.47591642426847525, 0.8382399756387401, 0.7932585637799989, 0.3973491813948944, 0.22933863498769935, 0.2306065664180702, 0.2406017723512327, 0.23626100717383403, 0.6061870614272572, 0.6147836137730114, 0.12312721295383966, 0.18001608884831077, 0.20779755798938082, 0.20510441158007575, 0.22550964207795987, 0.22550964207795987, 0.22164241085894631, 0.22679019364949216, 0.22679019364949216, 0.2280665176525315, 0.22550964207795987, 0.22742888278754758, 0.23438545087158213, 0.23187033257030087, 0.2642218903004282, 0.26155539127238303, 0.27158655075869576, 0.11766308869356779, 0.043322320848739215, 0.332777282634072, 0.09111542389736349, 0.12897810174019642, 0.17683320971242622, 0.2383699397160075, 0.2451415679229515, 0.24345996994119767, 0.24958948127028846, 0.24903635829103998, 0.233787601075662, 0.29575474666713597, 0.40651844611296495, 0.4670561354577436, 0.4992734773299701, 0.4997651848360676, 0.4997651845447558, 0.49976518431170647, 0.49976518431170647, 0.49976518431170647, 0.49951945074697945, 0.49951945074697945, 0.4995194508636187, 0.4995194508636187, 0.4995194508636187, 0.4992734762208082, 0.49951945074697945, 0.49976518384560775, 0.49976518384560775, 0.49976518384560775, 0.49976518384560775, 0.49976518384560775, 0.49951945074697945, 0.49927347610405437, 0.49951945074697945, 0.49976518384560775, 0.49976518384560775, 0.49976518384560775, 0.49976518384560775, 0.49976518384560775, 0.8440968962550398, 0.9355827767678173, 0.8902601492330944, 0.28701818044539185, 0.05922351713051521, 0.08704326113194949, 0.49974923000850124, 0.4997492134609389, 0.4997491992440183, 0.49974918852306127, 0.4997491798996825, 0.4997491722085605, 0.4997491663819529, 0.4997491614876023, 0.4997491577585733, 0.4997491544956728, 0.4997491521650296, 0.9714661173950552, 0.9536402313060899, 0.9212409376727198, 0.9365040437435482, 0.8582079110173417, 0.49974914400777815, 0.4997491433085852, 0.49974914284245653, 0.4997491426093922, 0.49974914191019915, 0.967448715266253, 0.49974914144407057, 0.4997491416771349, 0.4997491416771349, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.8823326117299426, 0.8823326117299426, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.7815145024120838, 0.7815145024120838, 0.8209294256540159, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974923000850124, 0.4997492134609389, 0.4997491992440183, 0.4981876481061105, 0.4973427652046465, 0.4995497526116349, 0.4997491663819529, 0.4997491614876023, 0.4997491577585733, 0.4997491544956728, 0.4997491521650296, 0.49974914983438634, 0.4995497418821274, 0.49974914680455007, 0.49974914563922845, 0.4997491447069712, 0.49974914400777815, 0.4995497393163756, 0.49974914284245653, 0.4997491426093922, 0.4995497388498752, 0.7588150754162797, 0.6647294516349103, 0.4997491416771349, 0.4997491416771349, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.4995497386166251, 0.533083860830046, 0.5484400606469819, 0.4924597663838567, 0.7580149488711614, 0.8876497153684101, 0.9285638987367335, 0.9485191511745047, 0.9597289501076971, 0.9669439937557706, 0.4315887000656533, 0.44726054350385847, 0.4526929231280177, 0.4574328390451241, 0.43859238278727697, 0.4404726341967782, 0.450893977568388, 0.4591891766745426, 0.45269286063804626, 0.4568447932671402, 0.45269285171090634, 0.40028839503656877, 0.4204140959702888, 0.43922048853522566, 0.47845961288118, 0.5122656311853926, 0.49517401560143837, 0.5474072498080492, 0.5508901144825344, 0.5879672146734645, 0.5769146221617104, 0.6184930972634304, 0.6107165301534203, 0.6322604849588778, 0.6137546358171528, 0.6420837648580722, 0.6042448397556253, 0.5549280776851137, 0.5894848258153953, 0.6750443606017053, 0.6511378474176918, 0.6610470821597396, 0.7356093524692184, 0.773180445695801, 0.7940576254194485, 0.7833761606160434, 0.7312138114821344, 0.7465719198880976, 0.7584209639554288, 0.7728720772874147, 0.7721492798947642, 0.7376850211907927, 0.6956290327431008, 0.7159820422247599, 0.7438519589317347, 0.7320759311088959, 0.748605810327729, 0.7460582946453883, 0.7678216147311914, 0.7762186932422646, 0.33037808202575836, 0.29280690640559026, 0.2889855582309516, 0.11175620846757561, 0.3804621453700552, 0.3576230150471601, 0.29843041011094695, 0.23051940892545164, 0.15139175522023218, 0.25818027051439896, 0.24244396558828019, 0.24814014934243833, 0.21303059652322476, 0.35707235774539237, 0.3665754676340547, 0.20594795036299463, 0.2640044721649224, 0.28437167106185834, 0.22482555640348478, 0.271864979667804, 0.2636431471476768, 0.336010565157036, 0.3075000917824454, 0.28905305100182055, 0.2668824036999493, 0.25337985786920103, 0.29380598745982844, 0.33630437795729984, 0.3276768654672946, 0.27433096031658344, 0.2284145053022637, 0.22841450419334874, 0.33659793003072336, 0.3882760015327126, 0.3498262495389507, 0.2847129539718133, 0.28756642948397193, 0.2870928171021967, 0.1957290817681464, 0.09343150789233545, 0.2425169774263205, 0.21632009632956006, 0.1758909803786849, 0.2510266359346708, 0.21572823368251115, 0.242833457132964, 0.35686779709576055, 0.2921395750124043, 0.32918033348460307, 0.2928070824684872, 0.2538789215060878, 0.05350826732601022, 0.11233084061106391, 0.24855029113528881, 0.3202124603825346, 0.15634273339624527, 0.18703303179584774, 0.11713286265583933, 0.32284687646498855, 0.264127697268301, 0.23782249198973504, 0.21328666395861107, 0.14134067820262186, 0.0840202069239141, 0.048969743404777555, 0.05901388581804212, 0.1659849364752528, 0.30661627299286753, 0.1089874621631296, 0.12813486982085553, 0.2652573838889489, 0.2874546009418387, 0.3812107635179882, 0.0912687684656932, 0.2051725788092036, 0.12014210204665776, 0.13721231195957184, 0.127048198967334, 0.13869801118262803, 0.0735218822035506, 0.09262498588031354, 0.21351548816739996, 0.15739431631337208, 0.09182565171413193, 0.19143910147010712, 0.08795080335410366, 0.16073528486451671, 0.10083248001980571, 0.21922115996518687, 0.16390753101149025, 0.2705837418880781, 0.3140650802958507, 0.26715397705235255, 0.12956732193209486, 0.3069406615273168, 0.24169652351709592, 0.15373559266246928, 0.03453110964363815, 0.2605053652136453, 0.14576213049142273, 0.1330666010342284, 0.17276805717031862, 0.16669756138350222, 0.2187130681491959, 0.0764349567210525, 0.05253755039280228, 0.133126021728611, 0.3898633872463012, 0.051276620132084894, 0.09110156542805459, 0.1988765968810965, 0.1272564759358903, 0.17110918790152452, 0.14192607035209148, 0.3360609979664264, 0.2748598102565901, 0.12776814029746153, 0.28626417088043243, 0.265699703470221, 0.21917032334476239, 0.16619878596165383, 0.28287007881424486, 0.2595282036757599, 0.3543094467805751, 0.3326735325168958, 0.22343845412393393, 0.06720153027817366, 0.09930976352877519, 0.11156624702134599, 0.1841777904083297, 0.08944647905498782, 0.24113188574682343, 0.21618109744537217, 0.34432228899386663, 0.11795720433284407, 0.2007503386571554, 0.2977510456902911, 0.2995989581368693, 0.05662198355379644, 0.1292550569453922, 0.09113448694250337, 0.15693177348172505, 0.11836697616668512, 0.08098273290865687, 0.1131351708445053, 0.20351536229809053, 0.20390843046989549, 0.11294305384468417, 0.08647550947582106, 0.23199921915836885, 0.12439796982909523, 0.11579992819191975, 0.08731720625452477, 0.11423344430121662, 0.3132266091004634, 0.1720434217218091, 0.10342708706164339, 0.14180526840033425, 0.18034528990980536, 0.2768911845357245, 0.08740230235040891, 0.10028305768287937, 0.334221092237343, 0.03741975458710489, 0.10146145510233429, 0.1252356723030268, 0.16219604067964677, 0.12307429155368332, 0.14951859567209014, 0.27428085936130475, 0.14563945833115344, 0.09226950315118088, 0.2588554066430354, 0.2953932297843562, 0.19862082807014447, 0.24960360917258118, 0.2223084476088426, 0.15015868194028958, 0.11495719829962836, 0.14472686221068454, 0.3185509512105178, 0.384710490846807, 0.22763834355562318, 0.1552210483307832, 0.10773559977774783, 0.11467166266364115, 0.17068464723605759, 0.2148992929263862, 0.21120954710806672, 0.1993410342326083, 0.24832514502908198, 0.24062892500098843, 0.23016262225361617, 0.13649885924857375, 0.10804423387793838, 0.22821398911647006, 0.4011038501373215, 0.30860657992742546, 0.06731130807306085, 0.16479087294381645, 0.1855555705044558, 0.1114814148086587, 0.22721812596800217, 0.10735070333613395, 0.12492304111056718, 0.12879728161684545, 0.044855192001578725, 0.21551570350029947, 0.2092249685908112, 0.17680881956640437, 0.2043449277664967, 0.13496122797530397, 0.0542560251379085, 0.2700672140265514, 0.22765038839914853, 0.25307686794166817, 0.18662961294626124, 0.12031226539209294, 0.191866819539391, 0.16772332953915237, 0.26739199872179664, 0.1699750124349939, 0.13092408914320175, 0.2205316719177154, 0.09215135116807871, 0.19750375266153575, 0.24200445489827027, 0.05846039249731039, 0.3198627839758732, 0.2648626799358412, 0.23612400533997435, 0.2734819246309854, 0.2178822097933093, 0.135782058374752, 0.13898744708265554, 0.14846251754515094, 0.11114817498986296, 0.20013066953464154, 0.1118673370074853, 0.07929127229016186, 0.20105643498922188, 0.06604486631446638, 0.10418846305728635, 0.23562208680711305, 0.1190190068283411, 0.15465179701171072, 0.07820633877071481, 0.08786483665852274, 0.10497709923693821, 0.10206648828414944, 0.20122530371358904, 0.10117836194852503, 0.24517939273879308, 0.2698499287409869, 0.10235008181856986, 0.04530136129853024, 0.03270587292130822, 0.3134784642063637, 0.25083584426108874, 0.08256855414954023, 0.27799714498362005, 0.26984989150304417, 0.1778993347749631, 0.13576456760280387, 0.16166885079158122, 0.13561770417496632, 0.08248805883694288, 0.14738506556115372, 0.10981959220234605, 0.051773392647810446, 0.29177667043551436, 0.23619490309198332, 0.09759695745630426, 0.2083571352195127, 0.06295044288439078, 0.20754126254215366, 0.20062995825143515, 0.04118496317499487, 0.1175705926589119, 0.26640746670028137, 0.1740350647318123, 0.14537205247430496, 0.08842533476030845, 0.15921377550576876, 0.19316234245204977, 0.1768620495082659, 0.17252610394588175, 0.08943326101861415, 0.25214497933579205, 0.3660619005475291, 0.051424807414367835, 0.08086106103670698, 0.13167346447958006, 0.15502955215741765, 0.11158132993419945, 0.1910729232790943, 0.05365550981488687, 0.22524204615840315, 0.2827609367500147, 0.24945997237851358, 0.09029232186446112, 0.13647722349682145, 0.27855706872097974, 0.21216458021455709, 0.12572409511237426, 0.16983243966478112, 0.11428005332051772, 0.15436949661768984, 0.049583638280147335, 0.0731403945153466, 0.0660850036987427, 0.1117801787404783, 0.13491532197145417, 0.054178943451100525, 0.0969022253129127, 0.2576158408346745, 0.34530529978394897, 0.2747432470786808, 0.23149692160524027, 0.3027224953010641, 0.19894902774708534, 0.13882933376991602, 0.19404972556688171, 0.2424588486873236, 0.24840599312820733, 0.29598911560085006, 0.24312235161371754, 0.2000455472417837, 0.15458259709921585, 0.17545210678385725, 0.061096105640784826, 0.16736120164169221, 0.10718276537421068, 0.273276116133077, 0.3212537094096598, 0.3785184296685088, 0.2810136210976931, 0.21693231674541935, 0.08289150384817778, 0.31439030316048755, 0.24068327824730007, 0.17055639776613996, 0.14921942444349678, 0.2081420382872149, 0.12906280534987402, 0.10624507233331248, 0.09731492127205843, 0.2735096039823849, 0.22511386872592498, 0.27872090504941804, 0.21716195942725847, 0.13722314342101216, 0.1150055703704348, 0.13512974007219647, 0.2367572946092511, 0.27357671329784894, 0.10363923876828285, 0.07603934554450142, 0.14762024687608655, 0.16770544490390926, 0.2777948550288841, 0.1536324215612379, 0.07794156286799891, 0.15420521961707956, 0.17571800675113014, 0.2396697205447058, 0.23133339326365876, 0.14997024086465938, 0.11939326253093185, 0.1521610051504123, 0.14514037731840346, 0.23527717053273067, 0.22508367638229543, 0.15701633331202958, 0.18732941599335706, 0.16276708943556373, 0.20499345953235304, 0.06564921789469613, 0.22003923048459395, 0.2758391565624143, 0.2789812741129878, 0.27557607778883875, 0.27819830476742546, 0.29278983528505353, 0.3179468806657797, 0.3158407879396652, 0.3214283675140005, 0.31253866611688064, 0.1935424480761303, 0.059236128048974046, 0.23208383099465624, 0.05339047571947442, 0.12024845699855558, 0.1601911383617256, 0.1473587739528598, 0.1647914258515909, 0.13282882969967835, 0.11197511993877807, 0.1538042243063632, 0.22905232931909647, 0.23521697255118246, 0.2687607923348643, 0.0786235438566606, 0.18970062874845472, 0.10202407172880512, 0.11367159645889335, 0.2931881267834552, 0.26092666985156165, 0.2906413996283179, 0.2369827089689568, 0.29388057657088684, 0.2400445078582053, 0.15385462281198958, 0.19318921074949713, 0.2079177599599663, 0.29909739535180246, 0.2597690284689296, 0.36179125913029475, 0.2998737621495935, 0.34970142178232333, 0.19495122771425288, 0.319050914814866, 0.2713634739427303, 0.41141511401317155, 0.19894305879719787, 0.15836819198037977, 0.18676241217330258, 0.167252346518042, 0.09329409253662979, 0.3218454337966091, 0.15503778466516582, 0.17945724431914778, 0.24871937993149584, 0.542204723285187, 0.6574182719526618, 0.6639845089750996, 0.6294010535596284, 0.493904799951563, 0.4995150655589501, 0.4995497386166251, 0.4986786839003524, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497789689014, 0.4995497712716469, 0.4995497652071431, 0.4995497600756399, 0.4995497558771371, 0.4995497526116349, 0.4995497500458832, 0.49954974794663176, 0.4995497460806304, 0.49954974468112945, 0.4995497432816285, 0.4995497425818779, 0.4995497418821274, 0.49954974118237694, 0.49954974048262646, 0.49954974001612606, 0.49954973978287587, 0.4995497393163756, 0.4995497393163756, 0.4995497390831254, 0.4995497388498752, 0.4995497390831254, 0.4995497388498752, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.4995497386166251, 0.0497584111375291, 0.1011857437235778, 0.045230815043926564, 0.05033132270398266, 0.03234058715321997, 0.10028683282332662, 0.13418347218905624, 0.06038615626465971, 0.12239702515065398, 0.17937535756254785, 0.1403765112208104, 0.05144277610305781, 0.13286512552506535, 0.04922626447000222, 0.1325307227615249, 0.08259375537755509, 0.1393349784910306, 0.15463316218868117, 0.1427789133742311, 0.1436179080553387, 0.1314700660422199, 0.04260979701192302, 0.1287423386102885, 0.0520657369488563, 0.11141875796567957, 0.09934709033164724, 0.14580091491017133, 0.08028058412526551, 0.12022316751605389, 0.043718925733518876, 0.13444175033956063, 0.05352823656916583, 0.06510984401430486, 0.04482548844539125, 0.11512696136313427, 0.03758670460168423, 0.0533523110404619, 0.11853672399949089, 0.07398909333806136, 0.05844453051126508, 0.09092825750873235, 0.05113885702559273, 0.09952289637764689, 0.054941079330035114, 0.054632085669708785, 0.06563856476378171, 0.08428841387925745, 0.08713752145451781, 0.08604643001127055, 0.1647294455151167, 0.016202225845870055, 0.025445631821128245, 0.09112225901680304, 0.0819740454362693, 0.0740504985505499, 0.052645566381865794, 0.047240959407178096, 0.07051729021227238, 0.09246564714903416, 0.08144151159914548, 0.16293630787142688, 0.06336926121927622, 0.048914711599644556, 0.015860767377414597, 0.07575089479172992, 0.08510036010456845, 0.09056483115790859, 0.03570261880904835, 0.013074575163404045, 0.008487378062068007, 0.07095830988379159, 0.14499775222056221, 0.03109755200846509, 0.07087561231528128, 0.03344686593632129, 0.08961325435393364, 0.03576860963048334, 0.040930109692122185, 0.03582181857346678, 0.09380802307718239, 0.06984246447996523, 0.03460266545197299, 0.09269943377559497, 0.15953155414632236, 0.07320717378552832, 0.11221163322037442, 0.057754566595073165, 0.10011583892669274, 0.06488277904698969, 0.13016727985734156, 0.06910509680519317, 0.03410938563690913, 0.04406902823945702, 0.092836695738718, 0.005243692943146194, 0.10231431611053787, 0.04597528878007273, 0.4149552043567041, 0.27327658986805836, 0.08882737923188222, 0.12406857448569797, 0.0718640186500401, 0.07581853036653918, 0.07036352314993577, 0.07011599337250096, 0.028262891171470184, 0.09007704606735878, 0.03361414950842612, 0.030472980433360553, 0.026957290277208168, 0.03192042345194479, 0.04873353778433276, 0.10720635474085471, 0.022252686200412986, 0.03851222186673453, 0.049261157667420674, 0.04426050492486766, 0.018118319271951733, 0.07747171330727665, 0.009436526064177886, 0.02028309869065026, 0.04252404921678499, 0.08661465046926053, 0.05621243843384183, 0.056930541886155206, 0.042524047509186036, 0.03797418567020783, 0.0355298666559305, 0.13116385861982904, 0.03888761414185937, 0.07589756967760508, 0.03214857519200409, 0.08535933304310872, 0.056215579112393166, 0.04403111959030259, 0.09449843973885153, 0.04131496425841674, 0.04613306764107683, 0.05297485433435489, 0.06837311904585697, 0.04523336567060221, 0.12161170763792994, 0.05826121588185418, 0.10050934032220171, 0.05297485433435489, 0.06117266077650174, 0.06751490116995118, 0.08217036972562897, 0.09123437800091772, 0.1198772147360333, 0.04276039707150425, 0.05595414713976554, 0.04372950588106028, 0.04340663430646008, 0.049147982179667205, 0.0414649421572314, 0.03657613979684193, 0.06363840550275979, 0.04822644077792759, 0.05382471301967584, 0.09498770586357796, 0.054577883957721895, 0.1290705843214397, 0.06335152770027774, 0.045983187820221816, 0.13844068245358854, 0.04918455907980346, 0.07188753812741022, 0.05363055656646709, 0.04405198553135348, 0.057408450225336805, 0.06261918967055269, 0.07622236478297462, 0.033948275371585734, 0.0584073874989014, 0.048865382113160494, 0.06208861200658722, 0.041765513442901026, 0.035592325838873395, 0.03984078756136722, 0.13633366735490204, 0.06440839013601285, 0.04734390321875481, 0.058348213419990524, 0.05959832324232239, 0.05136425385860777, 0.06610732077906134, 0.05394653309304476, 0.04501855547569744, 0.05394653309304476, 0.0700917386193115, 0.0517302252861247, 0.07039682452965934, 0.0434065117989344, 0.05946698199197675, 0.11952948940631758, 0.04697074677741275, 0.05141276190877142, 0.0526813417525932, 0.055208349488564123, 0.4996922598382153, 0.4997492134609389, 0.4997491992440183, 0.49974918852306127, 0.4997491798996825, 0.4997491722085605, 0.4997491663819529, 0.4997491614876023, 0.4997491577585733, 0.4997491544956728, 0.4997491521650296, 0.49974914983438634, 0.4997491479698718, 0.49974914680455007, 0.49974914563922845, 0.4997491447069712, 0.49974914400777815, 0.4997491433085852, 0.49974914284245653, 0.4997491426093922, 0.49974914191019915, 0.4997491416771349, 0.49974914144407057, 0.4997491416771349, 0.4997491416771349, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.49974914144407057, 0.057024275026388516, 0.041851546486779245, 0.05252309024423418, 0.04797877655281768, 0.05627693756839258, 0.05252302231436157, 0.051768641163458584, 0.05176862818388395, 0.0525229853187037, 0.05477889091701926, 0.04873908901124713, 0.05101303010083158, 0.041851378693146146, 0.055528457586750735, 0.05176858798906969, 0.04949826185593831, 0.06516598337181989, 0.06663125053238383, 0.0622216010443396, 0.06369610515525637, 0.05777008727051813, 0.05176857835906168, 0.05252294456077222, 0.049498255124684754, 0.05402808019804495, 0.0403071938341234, 0.05925861082369521, 0.051013008713292396, 0.060001111357147696, 0.04949825386257467, 0.05252294288865189, 0.05025623484154196, 0.05101300829392885, 0.04873906120045324, 0.04415831681449511, 0.05402808019804495, 0.04721703256820997, 0.056276841145030065, 0.05101300829392885, 0.05252294288865189, 0.05101300829392885, 0.05327610977397079, 0.05252294288865189, 0.042621582559270954, 0.04721703256820997, 0.04797865521356959, 0.055528443048373344, 0.043390566853765855, 0.054778857009611936, 0.04721703256820997, 0.022561461174726793, 0.027760863251180434, 0.03968025792631724, 0.02689821291685013, 0.03715082936278791, 0.02430090081969849, 0.027760986497599394, 0.030339990361875513, 0.02948185797688485, 0.02168969151472777, 0.026034063524533413, 0.028622217684628026, 0.027761036016241025, 0.03715091462443487, 0.02776104239864341, 0.043032438594580835, 0.028622233722226054, 0.04386679720755615, 0.023432111546753287, 0.03375748533494882, 0.022561695852204133, 0.028622238775167785, 0.03460808795048387, 0.023432114433365014, 0.035457194061620734, 0.025168309165260472, 0.03883872700900037, 0.0277610538429508, 0.032905387699261435, 0.024300984604203713, 0.027761054283116482, 0.021689727837667205, 0.0677420838774414, 0.1115481146498708, 0.12080781645693683, 0.10865960774884842, 0.12080781645693683, 0.1137022388388984, 0.11939583020277666, 0.1115481146498708, 0.11726932657763911, 0.1122673185586407, 0.11868813496711172, 0.1201023897889184, 0.11298535901468787, 0.11797930134173595, 0.10865960774884842, 0.11939583020277666, 0.11655820791695282, 0.11939583020277666, 0.056808890192377004, 0.05504541895729165, 0.06118872951339538, 0.04792520053892202, 0.06205978636287446, 0.0866370664349485, 0.08332393483369327, 0.05504528964123512, 0.06292922382822574, 0.040696840494277686, 0.05060770538028336, 0.037041375900801254, 0.05149853834517393, 0.04971517416255533, 0.05680868037131637, 0.055927785618757775, 0.04792508572852183, 0.058565536454808775, 0.05680867353607788, 0.0620596945996833, 0.04432461253882536, 0.05327520315522227, 0.04882096321436158, 0.05149852263512933, 0.05856553047044033, 0.051498520959391225, 0.05592777773316815, 0.03150564090662922, 0.05768791912105187, 0.05060767809836475, 0.05680866918638061, 0.0425141440997312, 0.051498520959391225, 0.05856553047044033, 0.057687918707566954, 0.05680866918638061, 0.03978554682157842, 0.05592777731813714, 0.044324609987051455, 0.05504523849693288, 0.04522727786090286, 0.05856553047044033, 0.05944150904666601, 0.05416104809962641, 0.05504523849693288, 0.04702750765126262, 0.05856553047044033, 0.030576827923694205, 0.04702750765126262, 0.044324609987051455, 0.00524326532935826, 0.005243344585389886, 0.017007038257283558, 0.005706830984131939, 0.005243506783740637, 0.00524354180383213, 0.014030956913332226, 0.005243595255546074, 0.007861986898608953, 0.00524362658930666, 0.010956119379587625, 0.005243654236740891, 0.0052436597662275375, 0.005243667138876362, 0.01700689179627901, 0.012927573958193661, 0.006744719539737543, 0.0088955475799265, 0.006744717242732734, 0.0052436892568220594, 0.017006882347180508, 0.006744714256626372, 0.020044308769477825, 0.017006881447266364, 0.013950564419136446, 0.006744712419022525, 0.013008193672850443, 0.005706699090529677, 0.007780561613117465, 0.026063194460751782, 0.005706698630167928, 0.006744712419022525, 0.006744712419022525, 0.009845790504731444, 0.008814251603755707, 0.009845790504731444, 0.008814251603755707, 0.0281312702544253, 0.005243692943146194, 0.009926923983180513, 0.018021445415962734, 0.005788511814763697, 0.009845790504731444, 0.005243692943146194, 0.005243692943146194, 0.005243692943146194, 0.016070344934024705, 0.005243692943146194, 0.025143844469092458, 0.005243692943146194, 0.016752685363031983, 0.005243344585389886, 0.005243407252940702, 0.009582981065044072, 0.009583006187899645, 0.009583025601014428, 0.0054388617385425775, 0.02080349138112847, 0.00524361368717019, 0.006478188067856383, 0.017363904529123286, 0.01061374293506212, 0.0052436597662275375, 0.00647820944146682, 0.00606403093160246, 0.0052436800410115, 0.010613759572817627, 0.005243683727335746, 0.010613761851962167, 0.014307659761993441, 0.011642275335228991, 0.005438930829996913, 0.005438930829996913, 0.005243694786308262, 0.010203001434930581, 0.010613766638165711, 0.005243694786308262, 0.014715021573989961, 0.005243694786308262, 0.010613766182336781, 0.005243694786308262, 0.010613766638165711, 0.008137827887564009, 0.00710200605981004, 0.01837840726784723, 0.014307655916325102, 0.008550308613577862, 0.005243692943146194, 0.013692899124198687, 0.00710200605981004, 0.008550308613577862, 0.006064018510769542, 0.006064018510769542, 0.009171490765010448, 0.016347243176281223, 0.005243692943146194, 0.005243692943146194, 0.01776871925504586, 0.005243692943146194, 0.013692899124198687, 0.00524326532935826, 0.005243344585389886, 0.010822415578574884, 0.006700043243056841, 0.008765475416021906, 0.011847586495701612, 0.006843226256859736, 0.011847556031288065, 0.021119201461072934, 0.00524362658930666, 0.005243643177767376, 0.012870645781845824, 0.0052436597662275375, 0.005243667138876362, 0.005243674511524965, 0.015051539826219762, 0.005243681884173568, 0.016068043703579615, 0.005243685570497814, 0.022123265150604365, 0.008765371784655085, 0.005243694786308262, 0.00979488198562406, 0.006699912991150692, 0.005243694786308262, 0.005243694786308262, 0.008908158772040764, 0.005243694786308262, 0.009937373460120802, 0.005243694786308262, 0.008908159229442658, 0.005243692943146194, 0.005243692943146194, 0.005243692943146194, 0.009794880159288977, 0.005243692943146194, 0.005663950963058273, 0.018094771573531676, 0.011989403758532857, 0.01301223216347025, 0.005243692943146194, 0.005807636022482798, 0.005243692943146194, 0.005243692943146194, 0.01287062218675672, 0.005663950963058273, 0.007876802485512147, 0.005243692943146194, 0.018094771573531676, 0.005243692943146194, 0.014989319137201917, 0.005243344585389886, 0.005243407252940702, 0.0077953224285588485, 0.009856077447538025, 0.00524354180383213, 0.005243569451271135, 0.008845727619838262, 0.014970710721404323, 0.00524362658930666, 0.013951987682278011, 0.005243654236740891, 0.01700179599107432, 0.022043115964562432, 0.01497067706058286, 0.012931150559248206, 0.005243681884173568, 0.009855977924568937, 0.005745060704199334, 0.009855975185404375, 0.007814359480747268, 0.005243694786308262, 0.011908211177495631, 0.008826653955218977, 0.006761580123912592, 0.010902207291602406, 0.005243694786308262, 0.00987506289535367, 0.005243694786308262, 0.01803297397517256, 0.005243694786308262, 0.010902207291602406, 0.005243692943146194, 0.005243692943146194, 0.005243692943146194, 0.005243692943146194, 0.008845783887353353, 0.005243692943146194, 0.01600612553207026, 0.005243692943146194, 0.01295011512614408, 0.008826652125310641, 0.0057258138838984785, 0.0057258138838984785, 0.005243692943146194, 0.005243692943146194, 0.007795190630024318, 0.011927222345787691, 0.0057258138838984785, 0.01295011512614408, 0.00524326532935826, 0.005243344585389886, 0.01105578268818741, 0.00590114040957368, 0.005901115099583021, 0.00796937547941512, 0.005243569451271135, 0.007969344775404452, 0.01684527665659985, 0.011751004609850568, 0.019876729080460342, 0.005243654236740891, 0.0052436597662275375, 0.005243667138876362, 0.013102543445770998, 0.010028989352564355, 0.006936232290216338, 0.027869934119645, 0.013795071207106768, 0.02885992696643247, 0.005243691099984127, 0.015830670385813317, 0.005243694786308262, 0.005243694786308262, 0.005243694786308262, 0.017171034036882915, 0.013102531653768956, 0.014122811955127879, 0.016845321892154153, 0.005243694786308262, 0.01583067218995149, 0.005243692943146194, 0.005243692943146194, 0.01105562215201028, 0.005243692943146194, 0.013795075962580228, 0.005243692943146194, 0.013795075962580228, 0.007969288408334996, 0.006603693332082328, 0.010028980225206263, 0.010725843844892502, 0.010028980225206263, 0.01105562215201028, 0.009000204530361655, 0.005243692943146194, 0.011751041674550655, 0.0069362251722470125, 0.009698516750052621, 0.005243692943146194]
        plt.figure(figsize=(60, 30))
        plt.plot(result, label="result")
        plt.legend()
        plt.show()

    def _generate_data(self, data_len=100, max_size=1000) -> List[Metrics]:
        data: List[Metrics] = []

        for name in self.names:
            df = pd.read_csv(name, sep=";", header=None)
            size_of_data = len(df.index)
            size_of_data = size_of_data if size_of_data < max_size else max_size
            num_parts = round(size_of_data * 2 / data_len) - 1

            for index in range(num_parts):
                start_idx = int(index * data_len / 2)
                end_idx = int((data_len * (index + 2)) / 2)
                part = df.iloc[start_idx:end_idx]

                if index < len(data):
                    metrics = data[index]
                    metrics.series[name] = part.iloc[:, 1].tolist()
                else:
                    metrics = Metrics([], 100,
                                      {name: part.iloc[:, 1].tolist()}, part.iloc[:, 0].tolist())

                if index < len(data):
                    data[index] = metrics
                else:
                    data.append(metrics)
        return data


if __name__ == '__main__':
    unittest.main()
